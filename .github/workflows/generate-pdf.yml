name: Build & Publish Docs

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

# Grant permission to create Releases
permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # --- VERSION EXTRACTION ---
      - name: Extract Version
        id: get_version
        run: |
          # Reads 'date: "v1.0.0"' and extracts just 'v1.0.0'
          VERSION=$(awk -F'"' '/date/ {print $2}' handbook_metadata.yaml | head -n 1)
          echo "Detected Version: $VERSION"
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      # --- INSTALL DEPENDENCIES ---
      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y pandoc texlive-latex-base texlive-fonts-recommended texlive-extra-utils texlive-latex-extra
          
          # Install Chrome for Mermaid (Non-Snap)
          wget -q https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
          sudo apt-get install -y ./google-chrome-stable_current_amd64.deb
          
          # Chrome Sandbox Wrapper
          echo '#!/bin/bash' > chrome_wrapper
          echo 'exec /usr/bin/google-chrome-stable --no-sandbox "$@"' >> chrome_wrapper
          chmod +x chrome_wrapper
          sudo mv chrome_wrapper /usr/bin/chrome-no-sandbox

      - name: Install & Configure Mermaid
        run: |
          npm install --global mermaid-filter
          echo '{ "executablePath": "/usr/bin/chrome-no-sandbox" }' > .puppeteer.json

      # --- BUILD HANDBOOK ---
      - name: Build Handbook PDF
        run: |
          cat handbook_metadata.yaml \
              src/commands/basics.md \
              src/commands/branching-and-remote.md \
              src/workflows/team-ops-manual.md \
              src/workflows/pull-requests.md \
              src/workflows/code-reviews.md \
              src/workflows/merge-conflicts.md \
              src/concepts/sha1-integrity.md \
              src/concepts/glossary.md \
              > handbook_combined.md

          pandoc handbook_combined.md \
            -o Git_Handbook.pdf \
            --filter mermaid-filter \
            --toc \
            --toc-depth=2 \
            -V colorlinks=true \
            --variable mainfont="DejaVu Sans" \
            --pdf-engine=pdflatex
        env:
          MERMAID_FILTER_CONFIG: .puppeteer.json

      # --- BUILD CHEAT SHEET (With filtering) ---
      - name: Build Cheat Sheet PDF
        run: |
          # Initialize with Metadata
          cat cheatsheet_metadata.yaml > cheatsheet_source.md

          # Filter Basics (Remove Installation section)
          sed '/^## Installation & GUIs/,/^## Setup/{/^## Setup/!d;}' src/commands/basics.md > basics_filtered.md
          
          # Filter out Mermaid blocks (Text Only for Cheat Sheet)
          for f in basics_filtered.md src/commands/branching-and-remote.md; do
            sed '/^```mermaid/,/^```/d' "$f" >> cheatsheet_source.md
            echo -e "\n\n" >> cheatsheet_source.md
          done

          pandoc cheatsheet_source.md \
            -o Git_Cheat_Sheet.pdf \
            --filter mermaid-filter \
            -V colorlinks=true \
            --variable mainfont="DejaVu Sans" \
            --pdf-engine=pdflatex
        env:
          MERMAID_FILTER_CONFIG: .puppeteer.json

      # --- DYNAMIC RELEASE ---
      - name: Publish Release
        uses: ncipollo/release-action@v1
        with:
          artifacts: "Git_Handbook.pdf,Git_Cheat_Sheet.pdf"
          tag: ${{ env.VERSION }}
          name: "Release ${{ env.VERSION }}"

          # Automatically generates Release Notes from .github/release.yml
          generateReleaseNotes: true
          allowUpdates: true
          replacesArtifacts: true
          makeLatest: true
          token: ${{ secrets.GITHUB_TOKEN }}